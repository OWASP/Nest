- name: Set up E2E environment
  runs:
    using: "composite"
    steps:
      - name: Wait for database to be ready
        run: |
          until docker exec ${{ job.services.db.id }} pg_isready -U nest_user_e2e -d nest_db_e2e; do
            echo "Waiting for database..."
            sleep 5
          done

      - name: Install PostgreSQL client
        run: sudo apt-get install -y postgresql-client

      - name: Load Postgres data
        env:
          PGPASSWORD: nest_user_e2e_password
        run: |
          gunzip -c backend/data/nest-e2e.sql.gz | psql -h localhost -U nest_user_e2e -d nest_db_e2e

      - name: Start Backend in the background
        run: |
          nohup docker run --rm --name nest-backend-e2e-runner \
            -e DJANGO_DB_HOST=db \
            -e DJANGO_DB_NAME=nest_db_e2e \
            -e DJANGO_DB_USER=nest_user_e2e \
            -e DJANGO_DB_PASSWORD=nest_user_e2e_password \
            -e DJANGO_DB_PORT=5432 \
            -p 8000:8000 \
            owasp/nest:test-backend-e2e-latest \
            sh -c '
              python manage.py runserver 0.0.0.0:8000
          '

      - name: Waiting for the backend to be ready
        run: |
          until curl -s http://localhost:8000/graphql > /dev/null; do
            echo "Waiting for backend..."
            sleep 3
          done
          echo "Backend is up!"
