name: Generate Backend Model Graphs

on:
  pull_request:
    paths:
      - backend/**/models.py
      - backend/**/models/**
  push:
    branches:
      - main
    paths:
      - backend/**/models.py
      - backend/**/models/**
  workflow_dispatch:

jobs:
  generate-backend-model-graphs:
    name: Generate Backend Model Graphs
    permissions:
      contents: read
    continue-on-error: true
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Install Poetry
        run: pipx install poetry

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405
        with:
          cache: "poetry"
          cache-dependency-path: backend/poetry.lock
          python-version: "3.13"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz

      - name: Install backend dependencies
        working-directory: backend
        run: |
          pip install poetry
          poetry install --no-interaction --no-root
          poetry run pip install django-extensions pydotplus pydot

      - name: Prepare output directories
        working-directory: backend
        run: |
          mkdir -p model-graphs/apps
          mkdir -p model-graphs/inter-app

      - name: Create CI settings wrapper
        working-directory: backend
        run: |
          mkdir -p settings
          cat > settings/ci_graphs.py <<'PY'
          from .local import *  # noqa

          if "django_extensions" not in Local.INSTALLED_APPS:
              Local.INSTALLED_APPS = list(Local.INSTALLED_APPS) + ["django_extensions"]
          PY

      - name: Set backend environment variables
        run: |
          echo "DJANGO_SETTINGS_MODULE=settings.ci_graphs" >> $GITHUB_ENV
          echo "DJANGO_CONFIGURATION=Local" >> $GITHUB_ENV
          echo "DJANGO_SECRET_KEY=dummy" >> $GITHUB_ENV
          echo "DJANGO_ALGOLIA_APPLICATION_ID=None" >> $GITHUB_ENV
          echo "DJANGO_ALGOLIA_WRITE_API_KEY=None" >> $GITHUB_ENV
          echo "DJANGO_REDIS_HOST=None" >> $GITHUB_ENV
          echo "DJANGO_REDIS_PASSWORD=None" >> $GITHUB_ENV
          echo "DJANGO_DB_NAME=None" >> $GITHUB_ENV
          echo "DJANGO_DB_USER=None" >> $GITHUB_ENV
          echo "DJANGO_DB_PASSWORD=None" >> $GITHUB_ENV
          echo "DJANGO_DB_HOST=None" >> $GITHUB_ENV
          echo "DJANGO_DB_PORT=None" >> $GITHUB_ENV
          echo "DJANGO_OPEN_AI_SECRET_KEY=None" >> $GITHUB_ENV
          echo "DJANGO_SLACK_BOT_TOKEN=None" >> $GITHUB_ENV
          echo "DJANGO_SLACK_SIGNING_SECRET=None" >> $GITHUB_ENV

      - name: Generate model graphs
        working-directory: backend
        run: poetry run python manage.py generate_model_graphs

      - name: Upload model graphs as artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: backend-model-graphs
          path: backend/model-graphs
