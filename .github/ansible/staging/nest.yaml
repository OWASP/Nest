- name: Deploy Staging Nest
  hosts: staging_nest
  tasks:
    - name: Copy docker-compose.yaml
      ansible.builtin.copy:
        src: "{{ github_workspace }}/docker/docker-compose-staging.yaml"
        dest: ~/docker-compose.yaml
        mode: "0644"
    - name: Ensure backend directory exists
      ansible.builtin.file:
        path: ~/backend
        state: directory
        mode: "0755"
    - name: Copy backend makefile
      ansible.builtin.copy:
        src: "{{ github_workspace }}/backend/Makefile"
        dest: ~/backend/Makefile
        mode: "0644"
    - name: Update backend makefile for the staging environment
      ansible.builtin.shell:
        cmd: sed -i 's/\bnest-backend\b/staging-nest-backend/' ~/backend/Makefile
    - name: Ensure cspell directory exists
      ansible.builtin.file:
        path: ~/cspell
        state: directory
        mode: "0755"
    - name: Copy cspell makefile
      ansible.builtin.copy:
        src: "{{ github_workspace }}/cspell/Makefile"
        dest: ~/cspell/Makefile
        mode: "0644"
    - name: Ensure frontend directory exists
      ansible.builtin.file:
        path: ~/frontend
        state: directory
        mode: "0755"
    - name: Copy frontend makefile
      ansible.builtin.copy:
        src: "{{ github_workspace }}/frontend/Makefile"
        dest: ~/frontend/Makefile
        mode: "0644"
    - name: Update frontend makefile for the staging environment
      ansible.builtin.shell:
        cmd: sed -i 's/\bnest-frontend\b/staging-nest-frontend/' ~/frontend/Makefile
    - name: Copy main makefile
      ansible.builtin.copy:
        src: "{{ github_workspace }}/Makefile"
        dest: ~/Makefile
        mode: "0644"
    - name: Ensure schema directory exists
      ansible.builtin.file:
        path: ~/schema
        state: directory
        mode: "0755"
    - name: Copy schema makefile
      ansible.builtin.copy:
        src: "{{ github_workspace }}/schema/Makefile"
        dest: ~/schema/Makefile
        mode: "0644"
    - name: Copy directory recursively
      ansible.builtin.copy:
        src: "{{ github_workspace }}/backend/data"
        dest: ~/
        mode: "0755"
    - name: Copy .env.backend
      ansible.builtin.copy:
        src: "{{ github_workspace }}/.env.backend"
        dest: ~/
        mode: "0400"
    - name: Copy .env.db
      ansible.builtin.copy:
        src: "{{ github_workspace }}/.env.db"
        dest: ~/
        mode: "0400"
    - name: Prune docker images
      ansible.builtin.shell:
        cmd: docker image prune -f
    - name: Update Docker images
      ansible.builtin.shell:
        cmd: docker compose pull
    - name: Restart services
      ansible.builtin.shell:
        cmd: docker compose up -d
    - name: Index data
      async: 1800
      poll: 0
      ansible.builtin.shell:
        cmd: make index-data > /var/log/nest/staging/index-data.log 2>&1
