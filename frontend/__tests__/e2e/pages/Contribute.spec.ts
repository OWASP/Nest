import { expectBreadCrumbsToBeVisible } from '@e2e/helpers/expects'
import { mockContributeData } from '@mockData/mockContributeData'
import { test, expect, Page, BrowserContext } from '@playwright/test'

test.describe.serial('Contribute Page', () => {
  let page: Page
  let context: BrowserContext
  test.beforeAll(async ({ browser }, testInfo) => {
    context = await browser.newContext({
      baseURL: testInfo.project.use.baseURL,
    })
    page = await context.newPage()
    await page.route('**/idx/', async (route) => {
      await route.fulfill({
        status: 200,
        body: JSON.stringify({
          hits: mockContributeData.issues,
          nbPages: 2,
        }),
      })
    })
    await page.goto('/contribute', { timeout: 25000 })
  })
  test.afterAll(async () => {
    await context.close()
  })
  test('renders issue data correctly', async () => {
    await expect(page.getByRole('link', { name: 'Contribution 1' })).toBeVisible({ timeout: 10000 })
    await expect(page.getByText('4 months ago')).toBeVisible()
    await expect(page.getByRole('link', { name: 'Owasp Nest', exact: true })).toBeVisible()
    await expect(page.getByText('This is a summary of Contribution 1')).toBeVisible()
    await expect(page.getByRole('button', { name: 'Read More' })).toBeVisible()
  })

  test('handles page change correctly', async () => {
    const nextPageButton = page.getByRole('button', { name: '2' })
    await nextPageButton.waitFor({ state: 'visible' })
    await nextPageButton.click()
    await expect(page).toHaveURL(/page=2/)
  })

  test('opens dialog on View Details button click', async () => {
    const contributeButton = page.getByRole('button', { name: 'Read More' }).first()
    await contributeButton.click()
    const dialog = page.getByRole('dialog')
    await expect(dialog).toBeVisible()
    await expect(
      dialog.getByText(
        'The issue summary and the recommended steps to address it have been generated by AI'
      )
    ).toBeVisible()
    await expect(dialog.getByRole('link', { name: 'View Issue', exact: true })).toBeVisible()
  })

  test('closes dialog on close button click', async () => {
    const closeButton = page.getByRole('button', { name: 'close-modal' })
    await expect(closeButton).toBeVisible()
    await closeButton.click()
  })
  test('breadcrumb renders correct segments on /contribute', async () => {
    await expectBreadCrumbsToBeVisible(page, ['Home', 'Contribute'])
  })
  test('displays "No Issues found" when there are no issues', async () => {
    await page.unroute('**/idx/')
    await page.route('**/idx/', async (route) => {
      await route.fulfill({
        status: 200,
        body: JSON.stringify({ hits: [], totalPages: 0 }),
      })
    })
    await page.goto('/contribute')
    await expect(page.getByText('No issues found')).toBeVisible()
  })
})
